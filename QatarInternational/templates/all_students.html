{% include "partials/header.html" %}

<main class="app-main">
  <div class="app-content-header">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-6"><h3 class="mb-0">Students</h3></div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Students</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="app-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12 mb-4">
          <div class="input-group">
            <input type="text" id="filterIdInput" class="form-control" placeholder="Filter by Student ID">
            <button class="btn btn-primary" onclick="filterStudents()">Filter</button>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header"><h3 class="card-title">All Students</h3></div>
          <div class="card-body">
            <table class="table table-bordered table-hover text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Profile</th>
                  <th>Name</th>
                  <th>Roll</th>
                  <th>Class</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="studentTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
  function getCSRFToken() {
    return document.querySelector('[name="csrfmiddlewaretoken"]').value;
  }

  function filterStudents() {
    const studentId = document.getElementById("filterIdInput").value;
    const tableBody = document.getElementById("studentTableBody");

    fetch(`/get_all_students_json?id=${studentId}`)
      .then(res => res.json())
      .then(data => {
        tableBody.innerHTML = "";

        if (data && data.students.length > 0) {
          data.students.forEach((student) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${student.sl}</td>
              <td><img src="${student.pp_url || 'https://via.placeholder.com/50'}" class="rounded-circle" width="50" height="50" style="object-fit:cover;"></td>
              <td>${student.s_name}</td>
              <td>${student.s_roll}</td>
              <td>${student.s_class}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="editStudent(${student.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        } else {
          tableBody.innerHTML = "<tr><td colspan='6'>No students found.</td></tr>";
        }
      })
      .catch(err => {
        console.error("Error fetching students:", err);
        alert("Failed to load students.");
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    filterStudents(); // Load all students initially
  });

  function editStudent(id) {
    alert("Edit feature coming soon for ID: " + id);
  }

  function deleteStudent(id) {
    if (confirm("Are you sure you want to delete this student?")) {
      fetch(`/delete_student/${id}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": getCSRFToken()
        }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        window.location.reload();
      })
      .catch(err => {
        console.error("Error deleting student:", err);
        alert("Failed to delete student.");
      });
    }
  }
</script>

{% include "partials/footer.html" %}
